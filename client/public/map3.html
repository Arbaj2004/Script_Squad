<!DOCTYPE html>
<html>
  <head>
    <title>Geolocation with Route to Nearest Nurse</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css"
    />
    <style>
      body {
        margin: 0;
        padding: 0;
      }
    </style>
  </head>

  <body>
    <div id="map" style="width: 100%; height: 100vh"></div>

    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <script>
      // Haversine formula to calculate distance in kilometers
      function getCoordinates() {
        const user = JSON.parse(localStorage.getItem("user"));
                  // `http://localhost:8000/api/v1/users/patients/${user._id}/nearest-nurses`
            return fetch(`http://localhost:8000/api/v1/users/getNC/${user._id}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Network response was not ok: " + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Coordinates data received:", data.data.loc.coordinates);
                    return data.data.loc.coordinates; // Returns [longitude, latitude]
                });
        }

      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Radius of Earth in kilometers
        const dLat = ((lat2 - lat1) * Math.PI) / 180;
        const dLon = ((lon2 - lon1) * Math.PI) / 180;
        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos((lat1 * Math.PI) / 180) *
            Math.cos((lat2 * Math.PI) / 180) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }

      // Fetch address using Nominatim API (reverse geocoding)
      async function getAddress(lat, lon) {
        try {
          const response = await fetch(
            `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`
          );
          const data = await response.json();
          return data.display_name || "Address not available";
        } catch (error) {
          console.error("Error fetching address:", error);
          return "Address not available";
        }
      }

      // Get the user's current location
      function getLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            async (position) => {
            //   const pos= [
            //     18.4459482,
            //     73.8085093
            // ]
            const pos= await getCoordinates()
              const sourceLat = pos[0];
              const sourceLng = pos[1];
              console.log(sourceLat);

              // Initialize the map centered on the user's location
              const map = L.map("map").setView([sourceLat, sourceLng], 11);

              // Use CartoDB tile layer for a different theme
              L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                maxZoom: 19,
              }).addTo(map);

              // Define custom icons for user and nurse
              const nurseIcon = L.icon({
                iconUrl:
                "https://media.istockphoto.com/id/1300845620/vector/user-icon-flat-isolated-on-white-background-user-symbol-vector-illustration.jpg?s=612x612&w=0&k=20&c=yBeyba0hUkh14_jgv1OKqIH0CCSWU_4ckRkAoy2p73o=",
                iconSize: [60, 60],
            });
            const userIcon = L.icon({
                iconUrl:
                "https://png.pngtree.com/png-clipart/20231114/original/pngtree-nurse-logo-vector-png-image_13542847.png",
                iconSize: [60, 60],
              });

              // Add a marker for the user's location
              const userAddress = await getAddress(sourceLat, sourceLng);
              L.marker([sourceLat, sourceLng], { icon: userIcon })
                .addTo(map)
                .bindPopup(`You are here<br>${userAddress}`)
                .openPopup();

              // Retrieve user data from localStorage
              const user = JSON.parse(localStorage.getItem("user"));
              if (user) {
                // Fetch nearest nurses from the backend
                // fetch(
                //   `http://localhost:8000/api/v1/users/patients/${user._id}/nearest-nurses`
            fetch(`http://localhost:8000/api/v1/users/getNC/${user._id}`)
            // )
                  .then((response) => {
                    if (!response.ok) {
                      throw new Error(
                        "Network response was not ok: " + response.statusText
                      );
                    }
                    return response.json();
                  })
                  .then(async (nurses) => {
                    // if (!Array.isArray(nurses) || nurses.length === 0) {
                    //   console.error("No nurses found.");
                    //   alert("No nurses available nearby.");
                    //   return;
                    // }

                    // Find the nearest nurse (assuming the first one is closest)
                    const nearestNurse = nurses[0];
                    const coo=[18.4459482,73.8085093]
                    const nurseLat = coo[0];
                    const nurseLng = coo[1];
                    
                    const distance = calculateDistance(
                      sourceLat,
                      sourceLng,
                      nurseLat,
                      nurseLng
                    ).toFixed(2);

                    const nurseAddress = await getAddress(nurseLat, nurseLng);

                    // Add a marker for the nearest nurse
                    L.marker([nurseLat, nurseLng], { icon: nurseIcon })
                      .addTo(map)
                      .bindPopup(
                        `<b>Your Patient nearby</b><br>Address: ${nurseAddress}<br>Distance: ${distance} km`
                      );

                    // Draw a route between the user and the nearest nurse
                    L.Routing.control({
                      waypoints: [
                        L.latLng(sourceLat, sourceLng),
                        L.latLng(nurseLat, nurseLng),
                      ],
                      routeWhileDragging: true,
                    }).addTo(map);
                  })
                  .catch((error) => {
                    console.error("Error fetching nurse data:", error);
                  });
              } else {
                console.error("User ID not found in localStorage.");
                alert("Please log in to retrieve nearby nurses.");
              }
            },
            (error) => {
              console.error("Error getting location: ", error);
              alert("Unable to retrieve your location.");
            }
          );
        } else {
          alert("Geolocation is not supported by this browser.");
        }
      }

      // Call the function to get the location and display the map
      getLocation();
    </script>
  </body>
</html>
